{#if isDebug}
  <button on:click="simulateTracking()">Simulate tracking</button>
{/if}
<TabContent trackingNumbers={allTrackingNumbers} />

<script>
  import Livechat from '@livechat/agent-app-widget-sdk';
  import { upsRegex } from './constants';
  import widgetRenderer from './widgetRenderer';
  import TabContent from './TabContent.html';
  import trackingSelector from './trackingSelector';

  export default {
    data() {
      return {
        rawResponseMap: {},
        allTrackingNumbers: [],
        isDebug: true
      };
    },

    oncreate() {
      this.handleCustomerMessage = this.handleCustomerMessage.bind(this);
      Livechat.on('message', this.handleCustomerMessage);
    },

    onupdate() {
      const { allTrackingNumbers } = this.get();
      widgetRenderer(allTrackingNumbers);
    },

    ondestroy() {
      Livechat.off('customer_profile', this.handleCustomerMessage);
    },

    methods: {
      async handleCustomerMessage({ message, message_source: messageSource }) {
        if (messageSource !== 'visitor') {
          return;
        }

        const result = message.match(upsRegex);
        if (!result) {
          return;
        }

        const [trackingNumber] = result;

        if (!trackingNumber) {
          return;
        }

        const trackingUrl = `https://localhost:54321/ups?tracking=${trackingNumber}`;

        try {
          const response = await fetch(trackingUrl);
          const json = await response.json();
          const trackingNumberFromResponse = trackingSelector.getTrackingNumber(json);

          if (json['Fault'] || !trackingNumberFromResponse) {
            throw json;
          }

          const { rawResponseMap } = this.get();
          rawResponseMap[trackingNumberFromResponse] = json;
          this.set({ rawResponseMap: { ...rawResponseMap } });
        } catch (e) {
          console.error(e);
        }
      },

      simulateTracking() {
        function getRandomInt(min, max) {
          return Math.floor(Math.random() * (max - min + 1) + min);
        }
  
        const debugTrackingNumbers = ['1Z648616E192760718', '1ZWX0692YP40636269', '1Z12345E1305277940'];
        this.handleCustomerMessage({ 
          message: debugTrackingNumbers[getRandomInt(0, 2)],
          message_source: 'visitor'
        });
      }
    },

    computed: {
      allTrackingNumbers: ({ rawResponseMap }) => {
        return Object.keys(rawResponseMap).map((trackingNumber) => {
          const rawResponse = rawResponseMap[trackingNumber];

          return {
            trackingNumber: trackingSelector.getTrackingNumber(rawResponse),
            status: trackingSelector.getStatus(rawResponse),
            rawJson: rawResponse
          };
        })
      }
    },

    components: {
      TabContent
    }
  };
</script>
