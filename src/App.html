{#if isDebug}
  <button on:click="simulateTracking()">Simulate tracking</button>
{/if}
<TabContent content={allResponses} />

<script>
  import Livechat from "@livechat/agent-app-widget-sdk";
  import { upsRegex } from './constants';
  import widgetRenderer from './widgetRenderer';
  import TabContent from './TabContent.html';

  export default {
    data() {
      return {
        allTrackingNumbers: {},
        isDebug: true
      };
    },

    oncreate() {
      this.handleButtonClickMessage = this.handleButtonClickMessage.bind(this);
      this.handleCustomerMessage = this.handleCustomerMessage.bind(this);
      Livechat.on("message", this.handleCustomerMessage);
      Livechat.on(
        "customer_details_section_button_click",
        this.handleButtonClickMessage
      );
    },

    onupdate() {
      const { allTrackingNumbers } = this.get();
      widgetRenderer(Object.keys(allTrackingNumbers), allTrackingNumbers);
      console.log('state: ', this.get());
    },

    ondestroy() {
      Livechat.off(
        "customer_details_section_button_click",
        this.handleButtonClickMessage
      );
      Livechat.off("customer_profile", this.handleCustomerMessage);
    },

    methods: {
      async handleButtonClickMessage({ buttonId }) {
        console.log('handling button click: ', buttonId);
      },

      async handleCustomerMessage({ message, message_source: messageSource }) {
        console.log('handling customer message: ', message);
        if (messageSource !== "visitor") {
          return;
        }

        const result = message.match(upsRegex);
        if (!result) {
          return;
        }

        const [trackingNumber] = result;

        if (!trackingNumber) {
          return;
        }

        const trackingUrl = `http://localhost:54321/ups?tracking=${trackingNumber}`;

        try {
          const response = await fetch(trackingUrl);
          const json = await response.json();

          if (json['Fault']) {
            throw json;
          }

          const { allTrackingNumbers } = this.get();
          const newTrackingObject = {};
          const status = json["TrackResponse"]["Shipment"]["Package"]["Activity"]["Status"]["Description"];
          newTrackingObject[trackingNumber] = { trackingNumber, status, json };
          this.set({
            allTrackingNumbers: { ...allTrackingNumbers, ...newTrackingObject }
          });
        } catch (e) {
          console.error(e);
        }
      },

      simulateTracking() {
        function getRandomInt(min, max) {
          return Math.floor(Math.random() * (max - min + 1) + min);
        }
  
        const debugTrackingNumbers = ['1Z648616E192760718', '1ZWX0692YP40636269', '1Z12345E1305277940'];
        this.handleCustomerMessage({ 
          message: debugTrackingNumbers[getRandomInt(0, 2)],
          message_source: 'visitor'
        });
      }
    },

    computed: {
      allResponses: ({ allTrackingNumbers }) => (
        Object.keys(allTrackingNumbers).map(trackingNumber => allTrackingNumbers[trackingNumber])
      )
    },

    components: {
      TabContent
    }
  };
</script>
