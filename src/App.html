<Debug isVisible={isDebug} on:loadTrackingNumber="handleCustomerMessage(event)" />
<div id="mainApp">
  <TabContent trackingNumbers={allTrackingNumbers} on:sendStatusClick="handleSendStatusLinkClick(event)" />
</div>

<style>
  :global(body) {
    background-color: #f3f7f9;
  }

  #mainApp {
    padding: 0 20px;
  }
</style>

<script>
  import Livechat from '@livechat/agent-app-widget-sdk';
  import { upsRegex } from './constants';
  import renderWidgets from './widgetRenderer';
  import TabContent from './TabContent.html';
  import Debug from './Debug';
  import trackingSelector from './trackingSelector';

  export default {
    data() {
      return {
        rawResponseMap: {},
        allTrackingNumbers: [],
        currentChat: '',
        isDebug: true
      };
    },

    oncreate() {
      this.handleCustomerProfile = this.handleCustomerProfile.bind(this);
      Livechat.on("customer_profile", this.handleCustomerProfile);

      this.handleCustomerMessage = this.handleCustomerMessage.bind(this);
      Livechat.on('message', this.handleCustomerMessage);

      this.handleButtonClickMessage = this.handleButtonClickMessage.bind(this);
      Livechat.on('customer_details_section_button_click', this.handleButtonClickMessage);

      const responseCache = localStorage.getItem('responseCache') || '{}';
      this.set({ rawResponseMap: JSON.parse(responseCache) });
    },

    onupdate() {
      const { allTrackingNumbers, rawResponseMap } = this.get();
      renderWidgets(allTrackingNumbers);
      //localStorage.setItem('responseCache', JSON.stringify(rawResponseMap));
    },

    ondestroy() {
      Livechat.off('customer_profile', this.handleCustomerProfile);
      Livechat.off('message', this.handleCustomerMessage);
      Livechat.off('customer_details_section_button_click', this.handleButtonClickMessage);
    },

    methods: {
      handleCustomerProfile({ chat: { id: chatId } }) {
        this.set({ currentChat: chatId });
        console.log('currentChat: ', chatId);
      },

      handleSendStatusLinkClick(trackingNumber) {
        const { rawResponseMap } = this.get();
        const trackingObject = rawResponseMap[trackingNumber];
        
        if (trackingObject) {
          const status = trackingSelector.getStatus(trackingObject);
          Livechat.putMessage(this.createMessageForAgent(trackingNumber, status));
        }
      },

      handleButtonClickMessage({ buttonId }) {
        const [ buttonType, value ] = buttonId.split('-');
        const { rawResponseMap } = this.get();
        const trackingObject = rawResponseMap[value];
        
        if (buttonType === 'sendstatus' && trackingObject) {
          const status = trackingSelector.getStatus(trackingObject);
          Livechat.putMessage(this.createMessageForAgent(value, status));
        }
      },

      async handleCustomerMessage({ chat, message, message_source: messageSource }, attempt = 0) {
        if (messageSource !== 'visitor') {
          return;
        }

        const regexResult = message.match(upsRegex);
        if (!regexResult) {
          return;
        }

        const [trackingNumber] = regexResult;
        if (!trackingNumber) {
          return;
        }

        const trackingUrl = `https://localhost:54321/ups?tracking=${trackingNumber}`;
        try {
          const response = await fetch(trackingUrl);
          const json = await response.json();
          const trackingNumberFromResponse = trackingSelector.getTrackingNumber(json);

          if (json['Fault'] || !trackingNumberFromResponse) {
            throw { json, trackingNumber, chat };
          }

          const { rawResponseMap } = this.get();

          if (!rawResponseMap[chat]) {
            rawResponseMap[chat] = {};
          }

          const rawResponseMapForChat = rawResponseMap[chat];
          rawResponseMapForChat[trackingNumberFromResponse] = json;
          this.set({ rawResponseMap: { ...rawResponseMap } });
        } catch (e) {
          console.error(e);
          const { json, trackingNumber } = e;
          const errorCode = trackingSelector.getErrorCode(json);

          // API sometimes doesn't work, workaround:
          if (errorCode === '10001' && attempt < 5) {
            setTimeout(() => {
              console.log(`Attempt #[${attempt}] - Retrying to fetch from UPS API.`)
              this.handleCustomerMessage({ message, chat, message_source: messageSource }, attempt + 1);
            }, 500);
            return;
          }

          const errorDescription = trackingSelector.getErrorDescription(json);
          if (errorDescription) {
            const { rawResponseMap } = this.get();
            if (!rawResponseMap[chat]) {
              rawResponseMap[chat] = {};
            }

            const rawResponseMapForChat = rawResponseMap[chat];    
            rawResponseMapForChat[trackingNumber] = { trackingNumber, errorMessage: errorDescription };
            this.set({ rawResponseMap: { ...rawResponseMap } });
          }
        }
      },

      createMessageForAgent(trackingNumber, status) {
        return `${trackingNumber}\nPackage status:\n${status}`;
      }
    },

    computed: {
      allTrackingNumbers: ({ rawResponseMap, currentChat }) => {
        console.log('rawResponseMap: ', rawResponseMap);
        console.log('currentChat: ', currentChat);
        const rawResponseMapForChat = rawResponseMap[currentChat] || {};
        console.log('allTrackingNumbers computed: ', rawResponseMapForChat);
        return Object.keys(rawResponseMapForChat).map((trackingNumber) => {
          const rawResponse = rawResponseMapForChat[trackingNumber];

          if (rawResponse.errorMessage) {
            return { 
              trackingNumber: rawResponse.trackingNumber,
              errorMessage: rawResponse.errorMessage,
              trackingValues: []
            };
          } else {
            return {
              trackingNumber: trackingSelector.getTrackingNumber(rawResponse),
              trackingValues: trackingSelector.getValues(rawResponse),
              rawJson: rawResponse
            };
          }
        })
      }
    },

    components: {
      TabContent,
      Debug
    }
  };
</script>
